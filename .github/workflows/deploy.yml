name: ğŸ¨ Deploy Frontend TeamLens to Production v2.1

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permitir ejecuciÃ³n manual

jobs:
  # ============================================================================
  # FRONTEND DEPLOYMENT
  # ============================================================================
  deploy-frontend:
    name: ğŸ¨ Deploy Frontend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¦ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: ğŸ“‹ Install Frontend Dependencies
      run: npm ci
    
    - name: ğŸ—ï¸ Build Production Angular App
      run: npm run build -- --configuration=production
    
    - name: ğŸš€ Deploy Frontend to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        timeout: 30s
        command_timeout: 3m
        script: |
          echo "ğŸ¨ [v2.1-$(date +%H%M%S)] Iniciando deploy del frontend TeamLens..."
          echo "ğŸ” Verificando conectividad y configuraciÃ³n..."
          whoami
          pwd
          cd ~/teamlens/frontend_teamlens
          
          # Verificar directorios crÃ­ticos
          if [ ! -d "/var/www" ]; then
            echo "âŒ Error: Directorio /var/www no encontrado"
            exit 1
          fi
          
          # Backup con timestamp y rotaciÃ³n inteligente
          echo "ğŸ’¾ Creando backup del frontend actual..."
          BACKUP_DIR="/var/www/teamlens_backup_$(date +%Y%m%d_%H%M%S)"
          if [ -d "/var/www/teamlens" ]; then
            sudo cp -r /var/www/teamlens "$BACKUP_DIR" 2>/dev/null || echo "âš ï¸ No se pudo crear backup completo"
            
            # Limpiar backups antiguos (mantener solo los Ãºltimos 5)
            sudo find /var/www -maxdepth 1 -type d -name "teamlens_backup_*" -exec ls -td {} + | tail -n +6 | xargs -r sudo rm -rf
          fi
          
          # Preservar configuraciones especÃ­ficas de producciÃ³n
          echo "ğŸ“¥ Actualizando cÃ³digo desde repositorio..."
          if [ -f "src/environments/environment.prod.ts" ]; then
            git stash push -m "backup-prod-env-$(date +%Y%m%d_%H%M%S)" src/environments/environment.prod.ts 2>/dev/null || true
          fi
          
          git pull origin main || {
            echo "âŒ Error: No se pudo actualizar el cÃ³digo desde git"
            exit 1
          }
          
          # Restaurar configuraciÃ³n de producciÃ³n
          git stash pop 2>/dev/null || echo "â„¹ï¸ No habÃ­a configuraciÃ³n en stash"
          
          # Verificar integridad del proyecto Angular
          if [ ! -f "angular.json" ]; then
            echo "âŒ Error: angular.json no encontrado - No es un proyecto Angular vÃ¡lido"
            exit 1
          fi
          
          if [ ! -f "package.json" ]; then
            echo "âŒ Error: package.json no encontrado"
            exit 1
          fi
          
          # Instalar dependencias con timeout y verificaciÃ³n
          echo "ğŸ“¦ Instalando dependencias de Angular..."
          timeout 300 npm ci || {
            echo "âŒ Error: Timeout en instalaciÃ³n de dependencias"
            echo "ğŸ“‹ Intentando diagnÃ³stico..."
            npm cache verify
            exit 1
          }
          
          # Build de producciÃ³n con optimizaciones
          echo "ğŸ—ï¸ Compilando aplicaciÃ³n Angular para producciÃ³n..."
          npm run build -- --configuration=production --optimization --aot --build-optimizer || {
            echo "âŒ Error: FallÃ³ la compilaciÃ³n de Angular"
            echo "ğŸ“‹ Verificando configuraciÃ³n..."
            if [ -f "angular.json" ]; then
              echo "âœ… angular.json existe"
            fi
            exit 1
          }
          
          # Verificar que el build fue exitoso
          if [ ! -d "dist/app17tb/browser" ]; then
            echo "âŒ Error: Directorio de build dist/app17tb/browser no fue generado"
            echo "ğŸ“‹ Contenido de dist/:"
            ls -la dist/ 2>/dev/null || echo "dist/ no existe"
            exit 1
          fi
          
          # Verificar archivos crÃ­ticos del build
          if [ ! -f "dist/app17tb/browser/index.html" ]; then
            echo "âŒ Error: index.html no fue generado en el build"
            exit 1
          fi
          
          echo "âœ… Build de Angular completado exitosamente"
          echo "ğŸ“Š Archivos generados en dist/app17tb/browser/:"
          ls -la dist/app17tb/browser/ | head -10
          
          # Despliegue con verificaciones de seguridad
          echo "ğŸš€ Desplegando archivos al servidor web..."
          
          # Crear directorio de destino si no existe
          sudo mkdir -p /var/www/teamlens
          
          # Limpiar directorio destino con verificaciÃ³n
          echo "ğŸ§¹ Limpiando directorio de destino..."
          sudo rm -rf /var/www/teamlens/* || {
            echo "âŒ Error: No se pudo limpiar el directorio de destino"
            exit 1
          }
          
          # Copiar archivos nuevos
          echo "ğŸ“ Copiando archivos del build..."
          sudo cp -r dist/app17tb/browser/* /var/www/teamlens/ || {
            echo "âŒ Error: No se pudieron copiar los archivos"
            exit 1
          }
          
          # Configurar permisos y propietario
          echo "ğŸ” Configurando permisos..."
          sudo chown -R www-data:www-data /var/www/teamlens/ || echo "âš ï¸ Advertencia: No se pudieron establecer propietarios"
          sudo chmod -R 755 /var/www/teamlens/ || echo "âš ï¸ Advertencia: No se pudieron establecer permisos"
          
          echo "âœ… Frontend desplegado exitosamente"
          
          # Verificaciones post-despliegue
          echo "ğŸ©º Verificando despliegue..."
          
          # Verificar archivos crÃ­ticos en destino
          if [ -f "/var/www/teamlens/index.html" ]; then
            echo "âœ… index.html desplegado correctamente"
          else
            echo "âŒ Error: index.html no encontrado en destino"
            exit 1
          fi
          
          # Verificar conectividad web
          echo "ğŸŒ Verificando accesibilidad web..."
          if curl -I http://teamlens.gti-ia.dsic.upv.es 2>/dev/null | grep -q "200\|301\|302"; then
            echo "âœ… Sitio web accesible"
          else
            echo "âš ï¸ Advertencia: No se pudo verificar accesibilidad web"
            echo "ğŸ“‹ Respuesta del servidor:"
            curl -I http://teamlens.gti-ia.dsic.upv.es 2>&1 | head -5
          fi
          
          # Verificar tamaÃ±o del despliegue
          DEPLOY_SIZE=$(sudo du -sh /var/www/teamlens | cut -f1)
          echo "ğŸ“Š TamaÃ±o del despliegue: $DEPLOY_SIZE"
          
          # Verificar algunos archivos JavaScript crÃ­ticos
          JS_FILES=$(find /var/www/teamlens -name "*.js" | wc -l)
          CSS_FILES=$(find /var/www/teamlens -name "*.css" | wc -l)
          echo "ğŸ“Š Archivos JavaScript: $JS_FILES"
          echo "ğŸ“Š Archivos CSS: $CSS_FILES"
          
          # Test bÃ¡sico de contenido
          if grep -q "TeamLens" /var/www/teamlens/index.html 2>/dev/null; then
            echo "âœ… Contenido de la aplicaciÃ³n verificado"
          else
            echo "âš ï¸ Advertencia: No se pudo verificar contenido de TeamLens"
          fi
          
          echo "ğŸ‰ Deploy del frontend completado - Timestamp: $(date)"
          echo "ğŸŒ URL: http://teamlens.gti-ia.dsic.upv.es" 