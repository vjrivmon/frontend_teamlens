<div class="algorithm-modal-container">
    <p-stepper [(activeStep)]="active" orientation="horizontal" class="compact-stepper">
        
        <!-- PASO 1: SELECCIONAR ESTUDIANTES + ALGORITMO -->
        <p-stepperPanel>
            <ng-template pTemplate="header" let-index="index">
                <button class="step-header">
                    <span class="step-number" [class.active]="index <= active">
                        <i class="pi pi-users"></i>
                    </span>
                    <span class="step-label">Estudiantes</span>
                </button>
            </ng-template>
            <ng-template pTemplate="content" let-nextCallback="nextCallback">
                <div class="step-content">
                    <div class="content-grid-spaced">
                        <!-- Columna izquierda: Algoritmo -->
                        <div class="algorithm-section-expanded">
                            <div class="algorithm-header">
                                <h3>Algoritmo de Emparejamiento</h3>
                                <p class="algorithm-description">Selecciona el test que utilizaremos para formar los equipos más eficaces.</p>
                            </div>
                            
                            <form [formGroup]="teamBuilderForm" class="algorithm-form">
                                <div class="form-field">
                                    <label for="algorithm" class="form-label">Selecciona el algoritmo:</label>
                                    <p-dropdown 
                                        formControlName="algorithm" 
                                        [options]="questionnaires" 
                                        optionLabel="title"
                                        placeholder="Selecciona un Algoritmo" 
                                        class="w-full" />
                                </div>
                            </form>

                            <!-- Información sobre Belbin - Estilo mejorado -->
                            <div class="belbin-info" *ngIf="teamBuilderForm.get('algorithm')?.value?.title === 'BELBIN'">
                                <div class="info-card">
                                    <div class="info-header">
                                        <i class="pi pi-lightbulb"></i>
                                        <span>Sobre el Test Belbin</span>
                                    </div>
                                    <div class="info-content">
                                        <p><strong>Belbin Team Roles</strong> es una metodología científica desarrollada por el Dr. Meredith Belbin tras más de 9 años de investigación sobre equipos exitosos.</p>
                                        
                                        <p>La investigación reveló que el éxito no dependía del intelecto, sino del <strong>comportamiento</strong>. Se identificaron 9 comportamientos críticos para el éxito de equipos.</p>
                                        
                                        <div class="belbin-features">
                                            <div class="feature-item">
                                                <i class="pi pi-check-circle"></i>
                                                <span>Identifica fortalezas y debilidades conductuales</span>
                                            </div>
                                            <div class="feature-item">
                                                <i class="pi pi-check-circle"></i>
                                                <span>Mejora la comunicación del equipo</span>
                                            </div>
                                            <div class="feature-item">
                                                <i class="pi pi-check-circle"></i>
                                                <span>Utilizado por miles de organizaciones</span>
                                            </div>
                                        </div>
                                        
                                        <p class="info-footer">
                                            Metodología reconocida como el estándar de oro para identificar contribuciones útiles en el trabajo.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna derecha: Selección de estudiantes -->
                        <div class="students-section-expanded">
                            <div class="section-header-spaced">
                                <div class="header-content">
                                    <h3>Seleccionar Estudiantes</h3>
                                    <p class="section-description">Elige los estudiantes que participarán en la formación de equipos.</p>
                                </div>
                                <div class="student-stats">
                                    <span class="stat-item">{{ selectedStudents.length }} de {{ students.length }} seleccionados</span>
                                    <div class="action-buttons-inline">
                                        <p-button size="small" severity="secondary" label="Todos" 
                                                  *ngIf="selectedStudents.length < students.length"
                                                  (onClick)="selectAllStudents()"></p-button>
                                        <p-button size="small" severity="secondary" label="Limpiar" 
                                                  *ngIf="selectedStudents.length > 0"
                                                  (onClick)="clearStudentSelection()"></p-button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Grid de estudiantes -->
                            <div class="students-grid-container" *ngIf="students.length > 0">
                                <div class="students-grid-scrollable">
                                    <div class="student-item" 
                                         *ngFor="let student of students; trackBy: trackByStudentId"
                                         [class.selected]="isStudentSelected(student)"
                                         (click)="toggleStudentSelection(student)">
                                        <div class="student-avatar">{{ getStudentInitials(student) }}</div>
                                        <div class="student-info">
                                            <div class="student-name">{{ student.name || 'Sin nombre' }}</div>
                                            <div class="student-email">{{ student.email }}</div>
                                        </div>
                                        <i class="pi pi-check check-icon" *ngIf="isStudentSelected(student)"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div *ngIf="students.length === 0" class="empty-state">
                                <i class="pi pi-users"></i>
                                <p>No hay estudiantes disponibles</p>
                                <small>Añade estudiantes a la actividad primero</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navegación fija con botón a la derecha -->
                    <div class="step-navigation">
                        <div></div>
                        <p-button label="Siguiente" 
                                  icon="pi pi-arrow-right" 
                                  iconPos="right"
                                  [disabled]="!canGoToNextStep()" 
                                  (onClick)="nextCallback.emit()"></p-button>
                    </div>
                </div>
            </ng-template>
        </p-stepperPanel>

        <!-- PASO 2: CONFIGURACIÓN DE GRUPOS -->
        <p-stepperPanel>
            <ng-template pTemplate="header" let-index="index">
                <button class="step-header">
                    <span class="step-number" [class.active]="index <= active">
                        <i class="pi pi-sitemap"></i>
                    </span>
                    <span class="step-label">Grupos</span>
                </button>
            </ng-template>
            <ng-template pTemplate="content" let-prevCallback="prevCallback" let-nextCallback="nextCallback">
                <div class="step-content">
                    <div class="groups-config-section-scrollable">
                        <div class="section-header-spaced">
                            <h3>Configuración de Grupos</h3>
                            <p class="section-description">Define cuántos grupos de cada tamaño necesitas para los {{ selectedStudents.length }} estudiantes seleccionados.</p>
                        </div>
                        
                        <!-- Información de estudiantes con más espacio -->
                        <div class="students-summary-spaced">
                            <div class="summary-card-enhanced">
                                <div class="summary-icon">
                                    <i class="pi pi-users"></i>
                                </div>
                                <div class="summary-info">
                                    <span class="summary-number">{{ selectedStudents.length }}</span>
                                    <span class="summary-label">Estudiantes seleccionados</span>
                                </div>
                                <div class="summary-status">
                                    <p-tag severity="success" value="Listos para formar grupos"></p-tag>
                                </div>
                            </div>
                        </div>

                        <!-- Configuraciones de grupos con mejor espaciado -->
                        <div class="group-configurations-spaced" *ngIf="groupConfigurations.length > 0">
                            <div class="configurations-header">
                                <h4>Configuraciones Activas</h4>
                                <p class="configurations-description">Cada configuración define un rango de grupos con un tamaño específico.</p>
                            </div>
                            
                            <div class="config-list-spaced">
                                <div class="config-item-enhanced" *ngFor="let config of groupConfigurations; let i = index">
                                    <div class="config-header">
                                        <span class="config-number">Configuración {{ i + 1 }}</span>
                                        <p-button icon="pi pi-trash" 
                                                  label="Eliminar"
                                                  size="small" 
                                                  severity="danger" 
                                                  text="true"
                                                  (onClick)="removeGroupConfiguration(i)">
                                        </p-button>
                                    </div>
                                    
                                    <div class="config-controls-spaced">
                                        <div class="control-group">
                                            <span class="control-label">Entre</span>
                                            <p-inputNumber [(ngModel)]="config.minQuantity" 
                                                           [min]="1" 
                                                           [max]="config.maxQuantity"
                                                           [showButtons]="true" 
                                                           [size]="1" 
                                                           class="compact-input"
                                                           (onInput)="updateGroupConfiguration()">
                                            </p-inputNumber>
                                        </div>
                                        
                                        <span class="control-separator">-</span>
                                        
                                        <div class="control-group">
                                            <p-inputNumber [(ngModel)]="config.maxQuantity" 
                                                           [min]="config.minQuantity" 
                                                           [max]="20"
                                                           [showButtons]="true" 
                                                           [size]="1" 
                                                           class="compact-input"
                                                           (onInput)="updateGroupConfiguration()">
                                            </p-inputNumber>
                                            <span class="control-label">grupos de</span>
                                        </div>
                                        
                                        <div class="control-group">
                                            <p-inputNumber [(ngModel)]="config.size" 
                                                           [min]="1" 
                                                           [max]="15"
                                                           [showButtons]="true" 
                                                           [size]="1" 
                                                           class="compact-input"
                                                           (onInput)="updateGroupConfiguration()">
                                            </p-inputNumber>
                                            <span class="control-label">estudiantes</span>
                                        </div>
                                    </div>
                                    
                                    <div class="config-summary-spaced">
                                        <div class="summary-tags">
                                            <p-tag [value]="getConfigurationSummary(config)" severity="info"></p-tag>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mensaje si no hay configuraciones -->
                        <div class="no-configurations" *ngIf="groupConfigurations.length === 0">
                            <div class="empty-config-state">
                                <i class="pi pi-sitemap"></i>
                                <h4>No hay configuraciones de grupos</h4>
                                <p>Añade al menos una configuración para definir cómo se formarán los grupos.</p>
                            </div>
                        </div>

                        <!-- Botón añadir configuración con más espacio -->
                        <div class="add-config-section-spaced">
                            <p-button icon="pi pi-plus" 
                                      label="Añadir Configuración de Grupo" 
                                      severity="secondary" 
                                      outlined="true"
                                      size="large"
                                      (onClick)="addGroupConfiguration()">
                            </p-button>
                            <small class="add-config-hint">
                                Puedes añadir múltiples configuraciones para crear diferentes tipos de grupos.
                            </small>
                        </div>

                        <!-- Vista previa mejorada -->
                        <div class="preview-section-enhanced" *ngIf="groupConfigurations.length > 0">
                            <div class="preview-header">
                                <h4>Vista Previa de la Configuración</h4>
                                <p class="preview-description">Resumen de cómo se distribuirán los estudiantes según tus configuraciones.</p>
                            </div>
                            <div class="preview-content">
                                <div class="preview-summary">
                                    <div class="preview-item">
                                        <i class="pi pi-users"></i>
                                        <span>{{ selectedStudents.length }} estudiantes total</span>
                                    </div>
                                    <div class="preview-item">
                                        <i class="pi pi-sitemap"></i>
                                        <span>{{ groupConfigurations.length }} configuración(es) definida(s)</span>
                                    </div>
                                </div>
                                <p-tag [value]="getGroupsConfigurationSummary()" 
                                       severity="success" 
                                       class="preview-result"></p-tag>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navegación fija -->
                    <div class="step-navigation">
                        <p-button label="Atrás" 
                                  icon="pi pi-arrow-left" 
                                  severity="secondary"
                                  (onClick)="prevCallback.emit()">
                        </p-button>
                        <p-button label="Siguiente" 
                                  icon="pi pi-arrow-right" 
                                  iconPos="right"
                                  [disabled]="groupConfigurations.length === 0"
                                  (onClick)="nextCallback.emit()">
                        </p-button>
                    </div>
                </div>
            </ng-template>
        </p-stepperPanel>

        <!-- PASO 3: CONFIGURAR RESTRICCIONES -->
        <p-stepperPanel>
            <ng-template pTemplate="header" let-index="index">
                <button class="step-header">
                    <span class="step-number" [class.active]="index <= active">
                        <i class="pi pi-link"></i>
                    </span>
                    <span class="step-label">Restricciones</span>
                </button>
            </ng-template>
            <ng-template pTemplate="content" let-prevCallback="prevCallback" let-nextCallback="nextCallback">
                <div class="step-content">
                    <div class="restrictions-config-section">
                        <div class="section-header">
                            <h3>Configurar Restricciones</h3>
                            <p>Define qué estudiantes deben ir juntos o separados en los equipos.</p>
                        </div>

                        <!-- Selector de estudiantes para restricciones -->
                        <div class="restriction-selector">
                            <h4>Seleccionar estudiantes para restricción</h4>
                            
                            <!-- Estudiantes seleccionados para restricción -->
                            <div class="selected-for-restriction" 
                                 [class.empty]="selectedRestrictionStudents.length === 0">
                                <div *ngIf="selectedRestrictionStudents.length > 0; else emptySelection" 
                                     class="selected-chips">
                                    <div class="restriction-chip" 
                                         *ngFor="let student of selectedRestrictionStudents"
                                         (click)="toggleRestrictionStudentSelection(student)">
                                        <span class="chip-avatar">{{ getStudentInitials(student) }}</span>
                                        <span class="chip-name">{{ student.name || student.email.split('@')[0] }}</span>
                                        <i class="pi pi-times chip-remove"></i>
                                    </div>
                                </div>
                                <ng-template #emptySelection>
                                    <div class="empty-selection">
                                        <i class="pi pi-info-circle"></i>
                                        <span>Selecciona estudiantes abajo para crear restricciones</span>
                                    </div>
                                </ng-template>
                            </div>

                            <!-- Grid de estudiantes disponibles -->
                            <div class="available-students">
                                <div class="student-item compact" 
                                     *ngFor="let student of selectedStudents"
                                     [class.selected]="isStudentInRestrictionSelection(student)"
                                     (click)="toggleRestrictionStudentSelection(student)">
                                    <div class="student-avatar">{{ getStudentInitials(student) }}</div>
                                    <span class="student-name">{{ student.name || student.email.split('@')[0] }}</span>
                                    <i class="pi pi-check check-icon" *ngIf="isStudentInRestrictionSelection(student)"></i>
                                </div>
                            </div>

                            <!-- Botones de acción -->
                            <div class="restriction-actions">
                                <p-button icon="pi pi-heart" label="Deben ir juntos" severity="success"
                                          [disabled]="selectedRestrictionStudents.length < 2"
                                          (onClick)="createRestriction('mustBeTogether')"></p-button>
                                <p-button icon="pi pi-ban" label="NO deben ir juntos" severity="danger"
                                          [disabled]="selectedRestrictionStudents.length < 2"
                                          (onClick)="createRestriction('mustNotBeTogether')"></p-button>
                                <p-button icon="pi pi-refresh" label="Limpiar" severity="secondary"
                                          [disabled]="selectedRestrictionStudents.length === 0"
                                          (onClick)="clearRestrictionSelection()"></p-button>
                            </div>
                        </div>

                        <!-- Restricciones existentes -->
                        <div class="existing-restrictions">
                            <!-- Mensaje cuando no hay restricciones -->
                            <div class="empty-restrictions-state" 
                                 *ngIf="restrictions.mustBeTogether.length === 0 && restrictions.mustNotBeTogether.length === 0">
                                <div class="empty-selection">
                                    <i class="pi pi-info-circle"></i>
                                    <span>Selecciona 2 estudiantes para crear restricciones</span>
                                </div>
                            </div>
                            
                            <!-- Restricciones cuando existen -->
                            <div *ngIf="restrictions.mustBeTogether.length > 0 || restrictions.mustNotBeTogether.length > 0">
                            
                            <!-- Deben ir juntos -->
                            <div class="restriction-group positive" *ngIf="restrictions.mustBeTogether.length > 0">
                                <div class="group-header">
                                    <i class="pi pi-heart"></i>
                                    <span>Deben ir juntos ({{ restrictions.mustBeTogether.length }})</span>
                                </div>
                                <div class="restriction-list">
                                    <div class="restriction-card" 
                                         *ngFor="let restriction of restrictions.mustBeTogether; let i = index">
                                        <div class="restriction-content">
                                            <span *ngFor="let student of restriction; let last = last">
                                                {{ student.name || student.email }}{{ !last ? ' + ' : '' }}
                                            </span>
                                        </div>
                                        <p-button icon="pi pi-times" size="small" text="true" severity="danger"
                                                  (onClick)="removeRestriction('mustBeTogether', i)"></p-button>
                                    </div>
                                </div>
                            </div>

                            <!-- NO deben ir juntos -->
                            <div class="restriction-group negative" *ngIf="restrictions.mustNotBeTogether.length > 0">
                                <div class="group-header">
                                    <i class="pi pi-ban"></i>
                                    <span>NO deben ir juntos ({{ restrictions.mustNotBeTogether.length }})</span>
                                </div>
                                <div class="restriction-list">
                                    <div class="restriction-card" 
                                         *ngFor="let restriction of restrictions.mustNotBeTogether; let i = index">
                                        <div class="restriction-content">
                                            <span *ngFor="let student of restriction; let last = last">
                                                {{ student.name || student.email }}{{ !last ? ' ≠ ' : '' }}
                                            </span>
                                        </div>
                                        <p-button icon="pi pi-times" size="small" text="true" severity="danger"
                                                  (onClick)="removeRestriction('mustNotBeTogether', i)"></p-button>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navegación fija -->
                    <div class="step-navigation">
                        <p-button label="Atrás" icon="pi pi-arrow-left" severity="secondary"
                                  (onClick)="prevCallback.emit()"></p-button>
                        <p-button label="Siguiente" icon="pi pi-arrow-right" iconPos="right"
                                  (onClick)="nextCallback.emit()"></p-button>
                    </div>
                </div>
            </ng-template>
        </p-stepperPanel>
        
        <!-- PASO 4: RESUMEN Y CONFIRMACIÓN -->
        <p-stepperPanel>
            <ng-template pTemplate="header" let-index="index">
                <button class="step-header">
                    <span class="step-number" [class.active]="index <= active">
                        <i class="pi pi-check"></i>
                    </span>
                    <span class="step-label">Confirmación</span>
                </button>
            </ng-template>
            <ng-template pTemplate="content" let-prevCallback="prevCallback">
                <div class="step-content">
                    <div class="summary-section">
                        <div class="section-header">
                            <h3>Resumen de Configuración</h3>
                            <p>Revisa todos los parámetros antes de crear los grupos.</p>
                        </div>

                        <!-- Resumen de algoritmo -->
                        <div class="summary-card">
                            <div class="card-header">
                                <i class="pi pi-cog"></i>
                                <span>Algoritmo Seleccionado</span>
                            </div>
                            <div class="card-content">
                                <p>{{ teamBuilderForm.get('algorithm')?.value?.title }}</p>
                            </div>
                        </div>

                        <!-- Resumen de estudiantes -->
                        <div class="summary-card">
                            <div class="card-header">
                                <i class="pi pi-users"></i>
                                <span>Estudiantes Participantes</span>
                            </div>
                            <div class="card-content">
                                <p>{{ selectedStudents.length }} estudiantes seleccionados</p>
                            </div>
                        </div>

                        <!-- Resumen de configuración de grupos -->
                        <div class="summary-card" *ngIf="groupConfigurations.length > 0">
                            <div class="card-header">
                                <i class="pi pi-sitemap"></i>
                                <span>Configuración de Grupos</span>
                            </div>
                            <div class="card-content">
                                <div class="config-summary-item" 
                                     *ngFor="let config of groupConfigurations">
                                    <p>Entre {{ config.minQuantity }}-{{ config.maxQuantity }} grupos de {{ config.size }} estudiantes</p>
                                    <small>{{ getConfigurationSummary(config) }}</small>
                                </div>
                                <p-tag [value]="getGroupsConfigurationSummary()" severity="success"></p-tag>
                            </div>
                        </div>

                        <!-- Resumen de restricciones -->
                        <div class="summary-card" 
                             *ngIf="restrictions.mustBeTogether.length > 0 || restrictions.mustNotBeTogether.length > 0">
                            <div class="card-header">
                                <i class="pi pi-link"></i>
                                <span>Restricciones Aplicadas</span>
                            </div>
                            <div class="card-content">
                                <div class="restriction-details" *ngIf="restrictions.mustBeTogether.length > 0">
                                    <div class="restriction-type-title">Deben ir juntos:</div>
                                    <div class="restriction-item-detail positive" 
                                         *ngFor="let restriction of restrictions.mustBeTogether">
                                        <div class="student-names">
                                            <span *ngFor="let student of restriction; let last = last">
                                                {{ student.name || student.email.split('@')[0] }}{{ !last ? ' + ' : '' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="restriction-details" *ngIf="restrictions.mustNotBeTogether.length > 0">
                                    <div class="restriction-type-title">NO deben ir juntos:</div>
                                    <div class="restriction-item-detail negative" 
                                         *ngFor="let restriction of restrictions.mustNotBeTogether">
                                        <div class="student-names">
                                            <span *ngFor="let student of restriction; let last = last">
                                                {{ student.name || student.email.split('@')[0] }}{{ !last ? ' ≠ ' : '' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estado del algoritmo -->
                        <div class="algorithm-status" *ngIf="algorithmProgress">
                            <div class="status-card" 
                                 [class.success]="algorithmProgress.includes('exitosamente')"
                                 [class.error]="algorithmProgress.includes('Error')">
                                <div class="status-icon">
                                    {{ algorithmProgress.includes('exitosamente') ? '🎉' : '❌' }}
                                </div>
                                <p>{{ algorithmProgress }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navegación fija -->
                    <div class="step-navigation">
                        <p-button label="Atrás" icon="pi pi-arrow-left" severity="secondary"
                                  [disabled]="isAlgorithmRunning" (onClick)="prevCallback.emit()"></p-button>
                        
                        <div class="final-action">
                            <p-button [label]="isAlgorithmRunning ? 'Procesando...' : 'Crear Grupos'" 
                                      [icon]="isAlgorithmRunning ? 'pi pi-spin pi-spinner' : 'pi pi-check'"
                                      iconPos="right" size="large"
                                      [disabled]="!canCreateGroups() || isAlgorithmRunning"
                                      [loading]="isAlgorithmRunning"
                                      (onClick)="onCreateGroups()"></p-button>
                            
                            <div *ngIf="isAlgorithmRunning" class="processing-info">
                                <span class="processing-text">{{ algorithmProgress }}</span>
                                <div *ngIf="getElapsedTime()" class="elapsed-time">{{ getElapsedTime() }}</div>
                            </div>
                            
                            <div *ngIf="!canCreateGroups() && !isAlgorithmRunning" class="validation-message">
                                {{ getValidationMessage() }}
                            </div>
                        </div>
                    </div>
                </div>
            </ng-template>
        </p-stepperPanel>
    </p-stepper>

    <!-- Modal de progreso (mantener funcionalidad original) -->
    <app-algorithm-progress-modal
        [visible]="showProgressModal"
        [progressMessage]="algorithmProgress"
        [elapsedTime]="elapsedTime"
        [estimatedTimeRemaining]="''"
        [isCompleted]="algorithmCompleted"
        [isSuccess]="algorithmSuccess"
        [groupsCreated]="algorithmsGroupsCreated"
        [errorMessage]="algorithmErrorMessage"
        (onClose)="onProgressModalClose()"
        (onCancel)="onProgressModalCancel()">
    </app-algorithm-progress-modal>
</div>