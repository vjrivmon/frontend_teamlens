<div class="modal-form-container">
    <p-stepper [(activeStep)]="active" class="responsive-stepper">
        <p-stepperPanel>
            <ng-template pTemplate="header" let-index="index">
                <button class="bg-transparent border-none inline-flex flex-column gap-2">
                    <span
                        class="border-round border-2 w-3rem h-3rem inline-flex align-items-center justify-content-center"
                        [ngClass]="{
                            'bg-primary border-primary': index <= active,
                            'surface-border': index > active
                        }">
                        <i class="pi pi-book"></i>
                    </span>
                </button>
            </ng-template>
            <ng-template pTemplate="content" let-nextCallback="nextCallback" let-index="index">
                <div class="flex flex-column gap-2 mt-4 stepper-content">
                    <h2>Configuraci√≥n B√°sica</h2>
                    <p>Selecciona el algoritmo de emparejamiento y configura los tipos de grupos que necesitas.</p>
                    
                    <form [formGroup]="teamBuilderForm" class="flex gap-4">
                        <div class="flex flex-column gap-2">
                            <h5>Algoritmo</h5>
                            <div class="flex flex-column gap-2">
                                <label for="algorithm">Algoritmo de Emparejamiento</label>
                                <p-dropdown formControlName="algorithm" [options]="questionnaires" optionLabel="title"
                                    placeholder="Selecciona un Algoritmo" />
                            </div>
                        </div>
                    </form>

                    <!-- Nueva secci√≥n moderna para configuraci√≥n de grupos -->
                    <div class="mt-6">
                        <div class="mb-4">
                            <h3 class="text-2xl font-bold text-900 mb-2">Configuraci√≥n de Grupos</h3>
                            <p class="text-600 line-height-3">Define cu√°ntos grupos de cada tama√±o necesitas. Por ejemplo: 3 grupos de 4 estudiantes + 2 grupos de 3 estudiantes</p>
                        </div>
                        
                        <!-- Card de resumen de estudiantes -->
                        <div class="bg-white border-round-lg shadow-1 p-4 mb-4">
                            <div class="flex align-items-center justify-content-between">
                                <div class="flex align-items-center gap-3">
                                    <div class="flex align-items-center justify-content-center w-3rem h-3rem bg-primary-50 border-round-md">
                                        <i class="pi pi-users text-primary text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-900 font-semibold m-0">{{ selectedStudents.length }} estudiantes seleccionados</h4>
                                        <p class="text-600 m-0 text-sm">{{ getTotalStudentsInGroups() }} asignados ‚Ä¢ {{ getRemainingStudents() }} disponibles</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p-tag [value]="getGroupsConfigurationSummary()" 
                                           [severity]="selectedStudents.length > 0 ? 'success' : 'secondary'" 
                                           class="font-medium"></p-tag>
                                </div>
                            </div>
                        </div>

                        <!-- Configuraci√≥n de rango de grupos -->
                        <div class="bg-white border-round-lg shadow-1 p-4 mb-4">
                            <div class="flex align-items-center gap-3 mb-4">
                                <div class="flex align-items-center justify-content-center w-2rem h-2rem bg-purple-50 border-round-md">
                                    <i class="pi pi-info-circle text-purple-600"></i>
                                </div>
                                <h5 class="m-0 text-900 font-semibold">Configuraci√≥n Inteligente de Grupos</h5>
                            </div>
                            
                            <div class="text-600 line-height-3">
                                <p class="m-0">Este sistema crea grupos autom√°ticamente bas√°ndose en los estudiantes disponibles. 
                                A√±ade configuraciones espec√≠ficas para definir rangos flexibles como "Entre 2-4 grupos de 5 estudiantes".</p>
                            </div>
                        </div>

                        <!-- Lista moderna de configuraciones de grupos con rangos -->
                        <div class="flex flex-column gap-4" *ngIf="groupConfigurations.length > 0">
                            <h5 class="text-900 font-semibold m-0">Configuraciones Activas</h5>
                            
                            <div *ngFor="let config of groupConfigurations; let i = index" 
                                 class="bg-white border-round-lg border-1 border-200 p-5 hover:shadow-2 transition-all transition-duration-200">
                                
                                <div class="flex flex-column gap-4">
                                    <!-- Secci√≥n de configuraci√≥n con rangos -->
                                    <div class="flex align-items-center gap-6 flex-wrap">
                                        <div class="flex align-items-center justify-content-center w-2rem h-2rem bg-blue-50 border-round-md">
                                            <i class="pi pi-sitemap text-blue-600"></i>
                                        </div>
                                        
                                        <div class="flex align-items-center gap-4 flex-wrap">
                                            <div class="flex align-items-center gap-4 text-lg">
                                                <span class="text-900 font-semibold text-lg whitespace-nowrap">Entre</span>
                                                <div class="flex align-items-center gap-2">
                                                    <p-inputNumber 
                                                        [(ngModel)]="config.minQuantity" 
                                                        [min]="1" 
                                                        [max]="config.maxQuantity"
                                                        [showButtons]="true"
                                                        [size]="1"
                                                        class="w-6rem"
                                                        (onInput)="updateGroupConfiguration()"
                                                        (ngModelChange)="updateGroupConfiguration()">
                                                    </p-inputNumber>
                                                </div>
                                                <span class="text-900 font-semibold text-lg mx-2">-</span>
                                                <div class="flex align-items-center gap-2">
                                                    <p-inputNumber 
                                                        [(ngModel)]="config.maxQuantity" 
                                                        [min]="config.minQuantity" 
                                                        [max]="20"
                                                        [showButtons]="true"
                                                        [size]="1"
                                                        class="w-6rem"
                                                        (onInput)="updateGroupConfiguration()"
                                                        (ngModelChange)="updateGroupConfiguration()">
                                                    </p-inputNumber>
                                                </div>
                                                <span class="text-900 font-semibold text-lg whitespace-nowrap mx-2">grupos de</span>
                                                <div class="flex align-items-center gap-2">
                                                    <p-inputNumber 
                                                        [(ngModel)]="config.size" 
                                                        [min]="1" 
                                                        [max]="15"
                                                        [showButtons]="true"
                                                        [size]="1"
                                                        class="w-6rem"
                                                        (onInput)="updateGroupConfiguration()">
                                                    </p-inputNumber>
                                                </div>
                                                <span class="text-900 font-semibold text-lg whitespace-nowrap">estudiantes</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Informaci√≥n y acciones -->
                                    <div class="flex align-items-center justify-content-between mt-2">
                                        <div class="flex align-items-center gap-3">
                                            <p-tag [value]="getConfigurationSummary(config)" 
                                                   severity="info" 
                                                   class="font-medium"></p-tag>
                                        </div>
                                        <button pButton 
                                                icon="pi pi-trash" 
                                                label="Eliminar"
                                                class="p-button-text p-button-sm p-button-danger"
                                                (click)="removeGroupConfiguration(i)"
                                                pTooltip="Eliminar configuraci√≥n"
                                                tooltipPosition="top">
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- √Årea de acciones simplificada -->
                        <div class="mt-4">
                            <button pButton 
                                    [label]="canAddMoreGroupConfigurations() ? 'A√±adir Configuraci√≥n de Grupo' : 'Selecciona estudiantes primero'"
                                    [icon]="canAddMoreGroupConfigurations() ? 'pi pi-plus' : 'pi pi-users'" 
                                    class="p-button-outlined w-full justify-content-center py-3"
                                    [disabled]="!canAddMoreGroupConfigurations()"
                                    (click)="addGroupConfiguration()">
                            </button>
                        </div>

                        <!-- Sistema de alertas moderno con emojis -->
                        <div *ngIf="getValidationMessage()" class="mt-5">
                            <div class="border-round-lg p-4 shadow-1" 
                                 [ngClass]="{
                                    'bg-blue-50 border-left-3 border-blue-500': getValidationType() === 'info',
                                    'bg-orange-50 border-left-3 border-orange-500': getValidationType() === 'warning',
                                    'bg-red-50 border-left-3 border-red-500': getValidationType() === 'error',
                                    'bg-green-50 border-left-3 border-green-500': getValidationType() === 'success'
                                 }">
                                <div class="flex align-items-start gap-3">
                                    <div class="flex align-items-center justify-content-center w-2rem h-2rem border-round-md" 
                                         [ngClass]="{
                                            'bg-blue-100': getValidationType() === 'info',
                                            'bg-orange-100': getValidationType() === 'warning',
                                            'bg-red-100': getValidationType() === 'error',
                                            'bg-green-100': getValidationType() === 'success'
                                         }">
                                        <span class="text-lg">
                                            <ng-container [ngSwitch]="getValidationType()">
                                                <span *ngSwitchCase="'info'">‚ÑπÔ∏è</span>
                                                <span *ngSwitchCase="'warning'">‚ö†Ô∏è</span>
                                                <span *ngSwitchCase="'error'">‚ùå</span>
                                                <span *ngSwitchCase="'success'">‚úÖ</span>
                                            </ng-container>
                                        </span>
                                    </div>
                                    <div class="flex-1">
                                        <p class="m-0 font-medium line-height-3" [ngClass]="{
                                            'text-blue-900': getValidationType() === 'info',
                                            'text-orange-900': getValidationType() === 'warning',
                                            'text-red-900': getValidationType() === 'error',
                                            'text-green-900': getValidationType() === 'success'
                                        }">{{ getValidationMessage() }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vista previa moderna de grupos -->
                        <div *ngIf="groupConfigurations.length > 0" class="mt-6">
                            <div class="bg-white border-round-lg shadow-1 p-4">
                                <div class="flex align-items-center gap-3 mb-4">
                                    <div class="flex align-items-center justify-content-center w-2rem h-2rem bg-indigo-50 border-round-md">
                                        <i class="pi pi-eye text-indigo-600"></i>
                                    </div>
                                    <h5 class="m-0 text-900 font-semibold">Vista Previa de Grupos (Promedio)</h5>
                                    <p-tag [value]="getGroupsPreview().length + ' grupos aprox.'" severity="info" class="ml-auto"></p-tag>
                                </div>
                                
                                <div class="grid">
                                    <div *ngFor="let preview of getGroupsPreview()" 
                                         class="col-12 sm:col-6 md:col-4 lg:col-3 xl:col-2">
                                        <div class="border-round-lg p-3 text-center transition-all transition-duration-200 hover:shadow-2 cursor-pointer"
                                             [style]="{ 
                                                'background': 'linear-gradient(135deg, ' + preview.color + '15, ' + preview.color + '05)', 
                                                'border': '2px solid ' + preview.color + '30' 
                                             }">
                                            <div class="flex align-items-center justify-content-center w-3rem h-3rem border-round-md mx-auto mb-2"
                                                 [style]="{ 'background-color': preview.color + '20' }">
                                                <i class="pi pi-users text-lg" [style]="{ 'color': preview.color }"></i>
                                            </div>
                                            <h6 class="m-0 font-semibold text-900 mb-1">{{ preview.name }}</h6>
                                            <p class="m-0 text-sm text-600">{{ preview.size }} estudiantes</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selecci√≥n de estudiantes - Estilo minimalista -->
                    <div class="mt-4">
                        <h3 class="text-xl font-semibold text-900 mb-3">Seleccionar Estudiantes</h3>
                        <p class="text-600 mb-4">Elige los estudiantes que participar√°n en la formaci√≥n de equipos.</p>
                        
                        <!-- Resumen de selecci√≥n simple -->
                        <div class="flex align-items-center justify-content-between mb-4 p-3 bg-gray-50 border-round">
                            <div class="flex align-items-center gap-2">
                                <i class="pi pi-users text-blue-600"></i>
                                <span class="font-medium">{{ selectedStudents.length }} de {{ students.length }} estudiantes seleccionados</span>
                            </div>
                            <div class="flex gap-2">
                                <button type="button" 
                                        class="p-button-sm p-button-outlined" 
                                        *ngIf="selectedStudents.length < students.length"
                                        (click)="selectAllStudents()">
                                    Seleccionar todos
                                </button>
                                <button type="button" 
                                        class="p-button-sm p-button-outlined" 
                                        *ngIf="selectedStudents.length > 0"
                                        (click)="clearStudentSelection()">
                                    Limpiar selecci√≥n
                                </button>
                            </div>
                        </div>

                        <!-- Lista de estudiantes simple -->
                        <div class="border-1 border-300 border-round p-3" style="max-height: 300px; overflow-y: auto;">
                            <div class="grid" *ngIf="students.length > 0">
                                @for (student of students; track student._id) {
                                    <div class="col-12 md:col-6">
                                        <div class="flex align-items-center gap-3 p-2 border-round cursor-pointer hover:bg-gray-50 transition-colors transition-duration-200"
                                             [class.bg-blue-50]="isStudentSelected(student)"
                                             [class.border-1]="isStudentSelected(student)"
                                             [class.border-blue-200]="isStudentSelected(student)"
                                             (click)="toggleStudentSelection(student)">
                                            <div class="flex align-items-center justify-content-center w-2rem h-2rem border-round text-white font-bold text-sm"
                                                 [style.backgroundColor]="isStudentSelected(student) ? '#3B82F6' : '#9CA3AF'">
                                                {{ getStudentInitials(student) }}
                                            </div>
                                            <div class="flex-1">
                                                <div class="font-medium text-900">{{ student.name || 'Sin nombre' }}</div>
                                                <div class="text-sm text-600">{{ student.email }}</div>
                                            </div>
                                            <div class="text-blue-600" *ngIf="isStudentSelected(student)">
                                                <i class="pi pi-check-circle"></i>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                            
                            <!-- Mensaje cuando no hay estudiantes -->
                            <div *ngIf="students.length === 0" class="text-center py-4">
                                <i class="pi pi-users text-3xl text-400 mb-2"></i>
                                <p class="text-600 m-0">No hay estudiantes disponibles</p>
                                <p class="text-sm text-500 m-0">A√±ade estudiantes a la actividad primero</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex pt-4 justify-content-end">
                    <p-button [disabled]="selectedStudents.length == 0" 
                              label="Siguiente" 
                              icon="pi pi-arrow-right"
                              iconPos="right" 
                              class="p-button-lg"
                              (onClick)="nextCallback.emit()" />
                </div>
            </ng-template>
        </p-stepperPanel>
        <p-stepperPanel>
            <ng-template pTemplate="header" let-index="index">
                <button class="bg-transparent border-none inline-flex flex-column gap-2">
                    <span
                        class="border-round border-2 w-3rem h-3rem inline-flex align-items-center justify-content-center"
                        [ngClass]="{
                            'bg-primary border-primary': index <= active,
                            'surface-border': index > active
                        }">
                        <i class="pi pi-users"></i>
                    </span>
                </button>
            </ng-template>
            <ng-template pTemplate="content" let-prevCallback="prevCallback" let-nextCallback="nextCallback"
                let-index="index">
                <div class="flex flex-column gap-4 mt-4 stepper-content">
                    
                    <!-- NUEVA SECCI√ìN: Restricciones redise√±adas -->
                    <div class="restrictions-section">
                        <div class="section-header mb-4 text-center">
                            <h2 class="text-2xl font-bold text-900 mb-2">Configurar Restricciones</h2>
                            <p class="text-600 line-height-3">Define qu√© estudiantes deben ir juntos o separados en los equipos.</p>
                        </div>

                        <!-- Selector de estudiantes para restricciones -->
                        <div class="restriction-selector mb-4">
                            <div class="bg-white border-round-lg shadow-1 p-4">
                                <h3 class="text-lg font-semibold text-900 mb-3">
                                    <i class="pi pi-users mr-2"></i>
                                    Seleccionar estudiantes para restricci√≥n
                                </h3>
                                
                                <!-- Grid compacto de estudiantes seleccionados -->
                                <div class="selected-students-compact mb-3">
                                    <div class="flex flex-wrap gap-2">
                                        @for (student of selectedStudents; track student._id) {
                                            <div class="student-chip" 
                                                 [class.chip-selected]="isStudentInRestrictionSelection(student)"
                                                 (click)="toggleRestrictionStudentSelection(student)">
                                                <span class="chip-avatar">{{ getStudentInitials(student) }}</span>
                                                <span class="chip-name">{{ student.name || student.email.split('@')[0] }}</span>
                                                <i class="pi pi-check chip-check" *ngIf="isStudentInRestrictionSelection(student)"></i>
                                            </div>
                                        }
                                    </div>
                                    
                                    <!-- Mensaje si no hay estudiantes seleccionados -->
                                    <div *ngIf="selectedStudents.length === 0" class="text-center py-3">
                                        <i class="pi pi-info-circle text-400 text-2xl mb-2"></i>
                                        <p class="text-600 m-0">Primero selecciona estudiantes en el paso anterior</p>
                                    </div>
                                </div>
                                
                                <!-- Botones de acci√≥n -->
                                <div class="flex justify-content-center gap-3" *ngIf="selectedRestrictionStudents.length >= 2">
                                    <p-button 
                                        label="Deben ir juntos" 
                                        icon="pi pi-heart"
                                        class="p-button-success"
                                        (onClick)="createRestriction('mustBeTogether')">
                                    </p-button>
                                    <p-button 
                                        label="NO deben ir juntos" 
                                        icon="pi pi-ban"
                                        class="p-button-danger"
                                        (onClick)="createRestriction('mustNotBeTogether')">
                                    </p-button>
                                </div>
                                
                                <div *ngIf="selectedRestrictionStudents.length < 2" class="text-center">
                                    <p class="text-600 text-sm m-0">Selecciona al menos 2 estudiantes para crear una restricci√≥n</p>
                                </div>
                            </div>
                        </div>

                        <!-- Restricciones existentes en dos columnas -->
                        <div class="restrictions-display">
                            <div class="grid">
                                
                                <!-- Columna: Deben ir juntos -->
                                <div class="col-12 md:col-6">
                                    <div class="restriction-column must-be-together">
                                        <div class="column-header">
                                            <i class="pi pi-heart"></i>
                                            <h3>Deben ir juntos</h3>
                                            <span class="restriction-count">{{ restrictions.mustBeTogether.length }}</span>
                                        </div>
                                        
                                        <div class="restrictions-list">
                                            @for (restriction of restrictions.mustBeTogether; track $index) {
                                                <div class="restriction-card positive">
                                                    <div class="restriction-students">
                                                        @for (student of restriction; track student._id; let isLast = $last) {
                                                            <span class="student-tag">{{ student.name || student.email.split('@')[0] }}</span>
                                                            @if (!isLast) {
                                                                <span class="connector">+</span>
                                                            }
                                                        }
                                                    </div>
                                                    <button class="remove-restriction" (click)="removeRestriction('mustBeTogether', $index)">
                                                        <i class="pi pi-times"></i>
                                                    </button>
                                                </div>
                                            }
                                            
                                            <!-- Mensaje cuando no hay restricciones -->
                                            <div *ngIf="restrictions.mustBeTogether.length === 0" class="empty-restrictions">
                                                <i class="pi pi-heart-fill text-green-400 text-2xl mb-2"></i>
                                                <p class="text-600 text-sm">No hay restricciones de compa√±erismo</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Columna: NO deben ir juntos -->
                                <div class="col-12 md:col-6">
                                    <div class="restriction-column must-not-be-together">
                                        <div class="column-header">
                                            <i class="pi pi-ban"></i>
                                            <h3>NO deben ir juntos</h3>
                                            <span class="restriction-count">{{ restrictions.mustNotBeTogether.length }}</span>
                                        </div>
                                        
                                        <div class="restrictions-list">
                                            @for (restriction of restrictions.mustNotBeTogether; track $index) {
                                                <div class="restriction-card negative">
                                                    <div class="restriction-students">
                                                        @for (student of restriction; track student._id; let isLast = $last) {
                                                            <span class="student-tag">{{ student.name || student.email.split('@')[0] }}</span>
                                                            @if (!isLast) {
                                                                <span class="connector">‚â†</span>
                                                            }
                                                        }
                                                    </div>
                                                    <button class="remove-restriction" (click)="removeRestriction('mustNotBeTogether', $index)">
                                                        <i class="pi pi-times"></i>
                                                    </button>
                                                </div>
                                            }
                                            
                                            <!-- Mensaje cuando no hay restricciones -->
                                            <div *ngIf="restrictions.mustNotBeTogether.length === 0" class="empty-restrictions">
                                                <i class="pi pi-ban text-red-400 text-2xl mb-2"></i>
                                                <p class="text-600 text-sm">No hay restricciones de separaci√≥n</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Navegaci√≥n del segundo paso -->
                <div class="flex pt-4 justify-content-between">
                    <p-button label="Atr√°s" 
                              icon="pi pi-arrow-left" 
                              class="p-button-outlined"
                              (onClick)="prevCallback.emit()" />
                    
                    <p-button label="Siguiente" 
                              icon="pi pi-arrow-right" 
                              iconPos="right"
                              [disabled]="!canGoToNextStep()"
                              (onClick)="nextCallback.emit()" />
                </div>
            </ng-template>
        </p-stepperPanel>
        
        <!-- PASO 3: PANTALLA DE RESUMEN/CONFIRMACI√ìN -->
        <p-stepperPanel>
            <ng-template pTemplate="header" let-index="index">
                <button class="bg-transparent border-none inline-flex flex-column gap-2">
                    <span
                        class="border-round border-2 w-3rem h-3rem inline-flex align-items-center justify-content-center"
                        [ngClass]="{
                            'bg-primary border-primary': index <= active,
                            'surface-border': index > active
                        }">
                        <i class="pi pi-check"></i>
                    </span>
                </button>
            </ng-template>
            <ng-template pTemplate="content" let-prevCallback="prevCallback" let-index="index">
                <div class="flex flex-column gap-2 mt-4 stepper-content">
                    <div class="mb-4">
                        <h2 class="text-2xl font-bold text-900 mb-2">Confirmaci√≥n</h2>
                        <p class="text-600 line-height-3">Revisa la configuraci√≥n antes de crear los grupos</p>
                    </div>
                    
                    <!-- Resumen de algoritmo -->
                    <div class="bg-white border-round-lg shadow-1 p-4 mb-4">
                        <div class="flex align-items-center gap-3 mb-3">
                            <div class="flex align-items-center justify-content-center w-2rem h-2rem bg-primary-50 border-round-md">
                                <i class="pi pi-cog text-primary"></i>
                            </div>
                            <h4 class="m-0 text-900 font-semibold">Algoritmo Seleccionado</h4>
                        </div>
                        <p class="text-lg text-700 m-0">{{ teamBuilderForm.get('algorithm')?.value?.title }}</p>
                    </div>
                    
                    <!-- Resumen de configuraci√≥n de grupos -->
                    <div class="bg-white border-round-lg shadow-1 p-4 mb-4" *ngIf="groupConfigurations.length > 0">
                        <div class="flex align-items-center gap-3 mb-3">
                            <div class="flex align-items-center justify-content-center w-2rem h-2rem bg-blue-50 border-round-md">
                                <i class="pi pi-sitemap text-blue-600"></i>
                            </div>
                            <h4 class="m-0 text-900 font-semibold">Configuraci√≥n de Grupos</h4>
                        </div>
                        <div class="grid">
                            <div *ngFor="let config of groupConfigurations; let i = index" class="col-12 md:col-6">
                                <div class="border-1 border-200 border-round p-3">
                                    <div class="flex align-items-center gap-2">
                                        <i class="pi pi-users text-primary"></i>
                                        <span class="font-medium">Entre {{ config.minQuantity }}-{{ config.maxQuantity }} grupos de {{ config.size }} estudiantes</span>
                                    </div>
                                    <p class="text-sm text-600 m-0 mt-1">{{ getConfigurationSummary(config) }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-green-50 border-round">
                            <div class="flex align-items-center gap-2 text-green-800">
                                <i class="pi pi-check-circle"></i>
                                <span class="font-medium">{{ getGroupsConfigurationSummary() }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Restricciones: Deben estar juntos -->
                    <div class="bg-white border-round-lg shadow-1 p-4 mb-4" *ngIf="restrictions.mustBeTogether.length > 0">
                        <div class="flex align-items-center gap-3 mb-3">
                            <div class="flex align-items-center justify-content-center w-2rem h-2rem bg-green-50 border-round-md">
                                <i class="pi pi-link text-green-600"></i>
                            </div>
                            <h4 class="m-0 text-900 font-semibold">Deben estar juntos</h4>
                        </div>
                        <div class="flex flex-column gap-2">
                            <div *ngFor="let restriction of restrictions.mustBeTogether; let i = index" 
                                 class="border-1 border-green-200 bg-green-50 border-round p-3">
                                <div class="flex align-items-start gap-2">
                                    <i class="pi pi-users text-green-600 mt-1"></i>
                                    <div class="flex-1">
                                        <div *ngFor="let student of restriction" class="text-green-800 font-medium">
                                            {{ student.name || student.email }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Restricciones: NO deben estar juntos -->
                    <div class="bg-white border-round-lg shadow-1 p-4 mb-4" *ngIf="restrictions.mustNotBeTogether.length > 0">
                        <div class="flex align-items-center gap-3 mb-3">
                            <div class="flex align-items-center justify-content-center w-2rem h-2rem bg-red-50 border-round-md">
                                <i class="pi pi-ban text-red-600"></i>
                            </div>
                            <h4 class="m-0 text-900 font-semibold">NO deben estar juntos</h4>
                        </div>
                        <div class="flex flex-column gap-2">
                            <div *ngFor="let restriction of restrictions.mustNotBeTogether; let i = index" 
                                 class="border-1 border-red-200 bg-red-50 border-round p-3">
                                <div class="flex align-items-start gap-2">
                                    <i class="pi pi-ban text-red-600 mt-1"></i>
                                    <div class="flex-1">
                                        <div *ngFor="let student of restriction" class="text-red-800 font-medium">
                                            {{ student.name || student.email }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje de resultado -->
                    <div *ngIf="!isAlgorithmRunning && algorithmProgress" class="mt-4">
                        <div class="border-round-lg p-4" 
                             [ngClass]="{
                                'bg-green-50 border-1 border-green-200': algorithmProgress.includes('exitosamente'),
                                'bg-red-50 border-1 border-red-200': algorithmProgress.includes('Error')
                             }">
                            <div class="flex align-items-center gap-3">
                                <div class="flex align-items-center justify-content-center w-2rem h-2rem border-round-md" 
                                     [ngClass]="{
                                        'bg-green-100': algorithmProgress.includes('exitosamente'),
                                        'bg-red-100': algorithmProgress.includes('Error')
                                     }">
                                    <span class="text-lg">
                                        {{ algorithmProgress.includes('exitosamente') ? 'üéâ' : '‚ùå' }}
                                    </span>
                                </div>
                                <p class="m-0 font-medium" 
                                   [ngClass]="{
                                      'text-green-900': algorithmProgress.includes('exitosamente'),
                                      'text-red-900': algorithmProgress.includes('Error')
                                   }">{{ algorithmProgress }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex pt-4 justify-content-between">
                        <p-button label="Atr√°s" 
                                  icon="pi pi-arrow-left" 
                                  class="p-button-outlined"
                                  [disabled]="isAlgorithmRunning"
                                  (onClick)="prevCallback.emit()" />
                        
                        <!-- Bot√≥n de crear grupos -->
                        <div class="flex flex-column align-items-end gap-2">
                            <p-button 
                                [label]="isAlgorithmRunning ? 'Procesando...' : 'Crear Grupos'" 
                                [icon]="isAlgorithmRunning ? 'pi pi-spin pi-spinner' : 'pi pi-check'"
                                iconPos="right" 
                                class="p-button-lg"
                                [disabled]="!canCreateGroups() || isAlgorithmRunning"
                                [loading]="isAlgorithmRunning"
                                (onClick)="onCreateGroups()" />
                            
                            <!-- Indicadores de progreso -->
                            <div *ngIf="isAlgorithmRunning" class="flex flex-column align-items-end gap-1">
                                <div class="flex align-items-center gap-2 text-sm">
                                    <p-progressSpinner 
                                        [style]="{'width': '16px', 'height': '16px'}" 
                                        strokeWidth="4"
                                        fill="transparent">
                                    </p-progressSpinner>
                                    <span class="text-600 font-medium">{{ algorithmProgress }}</span>
                                </div>
                                
                                <div *ngIf="getElapsedTime()" 
                                     class="text-xs text-500">
                                    {{ getElapsedTime() }}
                                </div>
                                
                                <div class="text-xs text-500 text-right max-w-20rem">
                                    Procesando {{ selectedStudents.length }} estudiantes con 
                                    {{ restrictions.mustBeTogether.length + restrictions.mustNotBeTogether.length }} restricciones
                                </div>
                            </div>
                            
                            <div *ngIf="!canCreateGroups() && !isAlgorithmRunning" 
                                 class="text-xs text-orange-600 max-w-15rem text-right">
                                {{ getValidationMessage() }}
                            </div>
                        </div>
                    </div>
                </div>
            </ng-template>
        </p-stepperPanel>
    </p-stepper>

    <!-- NUEVO: Modal dedicado para el progreso del algoritmo -->
    <app-algorithm-progress-modal
        [visible]="showProgressModal"
        [progressMessage]="algorithmProgress"
        [elapsedTime]="elapsedTime"
        [estimatedTimeRemaining]="''"
        [isCompleted]="algorithmCompleted"
        [isSuccess]="algorithmSuccess"
        [groupsCreated]="algorithmsGroupsCreated"
        [errorMessage]="algorithmErrorMessage"
        (onClose)="onProgressModalClose()"
        (onCancel)="onProgressModalCancel()">
    </app-algorithm-progress-modal>

</div>